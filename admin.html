<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Düzenleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBF0bchfUsw4yo1q1wU-rowR8RZ24CDgJ0",
            authDomain: "mete-73d7c.firebaseapp.com",
            projectId: "mete-73d7c",
            storageBucket: "mete-73d7c.firebasestorage.app",
            messagingSenderId: "785562796791",
            appId: "1:785562796791:web:4ee9767daf4a13a981c9f2",
            measurementId: "G-191XRBGG83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        const PROFILE_DOC_ID = 'main_professional_profile';
        let userId = null;
        let uploadedPhotoURL = null;

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                loadProfileData();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-content').classList.add('hidden');
            }
        });

        // Login function
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                error.textContent = '';
            } catch (e) {
                error.textContent = 'Giriş başarısız!';
            }
        }

        // Logout function
        async function logout() {
            await signOut(auth);
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const docRef = doc(db, 'artifacts', 'mete-73d7c', 'public', 'data', 'profiles', PROFILE_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Fill form fields
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('title').value = data.title || '';
                    document.getElementById('bio').value = data.bioText || '';
                    document.getElementById('linkedin').value = data.socials?.linkedin || '';
                    document.getElementById('github').value = data.socials?.github || '';
                    document.getElementById('email-contact').value = data.socials?.email || '';

                    // Photo
                    if (data.photoURL) {
                        document.getElementById('photo-preview').src = data.photoURL;
                        document.getElementById('photo-preview').classList.remove('hidden');
                        uploadedPhotoURL = data.photoURL;
                    }

                    // Load lists
                    loadList('expertise', data.expertise || []);
                    loadList('education', data.education || []);
                    loadList('experience', data.workExperience || []);
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Load list items
        function loadList(type, items) {
            const container = document.getElementById(`${type}-container`);
            container.innerHTML = '';
            
            items.forEach(item => {
                addListItem(type, item);
            });
        }

        // Add list item
        function addListItem(type, data = {}) {
            const container = document.getElementById(`${type}-container`);
            let html = '';

            if (type === 'expertise') {
                html = `
                    <div class="border p-3 rounded mb-2">
                        <input type="text" placeholder="Uzmanlık adı" value="${data.name || ''}" class="expertise-name w-full p-2 border rounded mb-2">
                        <input type="text" placeholder="İkon adı" value="${data.icon || ''}" class="expertise-icon w-full p-2 border rounded">
                        <button onclick="removeItem(this)" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm">Sil</button>
                    </div>
                `;
            } else if (type === 'education') {
                html = `
                    <div class="border p-3 rounded mb-2">
                        <input type="text" placeholder="Derece" value="${data.degree || ''}" class="w-full p-2 border rounded mb-2">
                        <input type="text" placeholder="Okul" value="${data.institution || ''}" class="w-full p-2 border rounded mb-2">
                        <input type="text" placeholder="Yıllar" value="${data.years || ''}" class="w-full p-2 border rounded mb-2">
                        <textarea placeholder="Açıklama" class="w-full p-2 border rounded mb-2">${data.description || ''}</textarea>
                        <button onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Sil</button>
                    </div>
                `;
            } else if (type === 'experience') {
                html = `
                    <div class="border p-3 rounded mb-2">
                        <input type="text" placeholder="Pozisyon" value="${data.title || ''}" class="w-full p-2 border rounded mb-2">
                        <input type="text" placeholder="Şirket" value="${data.company || ''}" class="w-full p-2 border rounded mb-2">
                        <input type="text" placeholder="Yıllar" value="${data.years || ''}" class="w-full p-2 border rounded mb-2">
                        <textarea placeholder="Açıklama" class="w-full p-2 border rounded mb-2">${data.description || ''}</textarea>
                        <button onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Sil</button>
                    </div>
                `;
            }

            container.insertAdjacentHTML('beforeend', html);
        }

        // Remove item
        function removeItem(button) {
            button.parentElement.remove();
        }

        // Photo upload
        async function uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);

            // Upload to Firebase
            try {
                const storageRef = ref(storage, `profile_photos/${userId}/${file.name}`);
                await uploadBytes(storageRef, file);
                uploadedPhotoURL = await getDownloadURL(storageRef);
                showMessage('Fotoğraf yüklendi!', 'green');
            } catch (error) {
                showMessage('Fotoğraf yükleme hatası!', 'red');
            }
        }

        // Save all data
        async function saveAll() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Kaydediliyor...';

            try {
                const docRef = doc(db, 'artifacts', 'mete-73d7c', 'public', 'data', 'profiles', PROFILE_DOC_ID);

                const dataToSave = {
                    name: document.getElementById('name').value,
                    title: document.getElementById('title').value,
                    bioText: document.getElementById('bio').value,
                    photoURL: uploadedPhotoURL || '',
                    socials: {
                        linkedin: document.getElementById('linkedin').value,
                        github: document.getElementById('github').value,
                        email: document.getElementById('email-contact').value
                    },
                    expertise: getExpertiseItems(),
                    education: getEducationItems(),
                    workExperience: getExperienceItems()
                };

                await setDoc(docRef, dataToSave);
                showMessage('Profil kaydedildi!', 'green');

            } catch (error) {
                console.error('Save error:', error);
                showMessage('Kaydetme hatası!', 'red');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Tümünü Kaydet';
            }
        }

        // Get list items
        function getExpertiseItems() {
            const items = [];
            document.querySelectorAll('#expertise-container > div').forEach(div => {
                const name = div.querySelector('.expertise-name').value;
                const icon = div.querySelector('.expertise-icon').value;
                if (name) items.push({ name, icon });
            });
            return items;
        }

        function getEducationItems() {
            const items = [];
            document.querySelectorAll('#education-container > div').forEach(div => {
                const inputs = div.querySelectorAll('input, textarea');
                if (inputs[0].value) {
                    items.push({
                        degree: inputs[0].value,
                        institution: inputs[1].value,
                        years: inputs[2].value,
                        description: inputs[3].value
                    });
                }
            });
            return items;
        }

        function getExperienceItems() {
            const items = [];
            document.querySelectorAll('#experience-container > div').forEach(div => {
                const inputs = div.querySelectorAll('input, textarea');
                if (inputs[0].value) {
                    items.push({
                        title: inputs[0].value,
                        company: inputs[1].value,
                        years: inputs[2].value,
                        description: inputs[3].value
                    });
                }
            });
            return items;
        }

        // Show message
        function showMessage(text, color) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `p-3 rounded mb-4 text-white bg-${color}-500`;
            message.classList.remove('hidden');
            
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        // Global functions
        window.login = login;
        window.logout = logout;
        window.uploadPhoto = uploadPhoto;
        window.saveAll = saveAll;
        window.removeItem = removeItem;
        window.addExpertise = () => addListItem('expertise');
        window.addEducation = () => addListItem('education');
        window.addExperience = () => addListItem('experience');
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-blue-600">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h2 class="text-2xl font-bold text-center mb-6">Yönetici Girişi</h2>
            
            <div class="space-y-4">
                <div>
                    <input type="email" id="email" placeholder="E-posta" class="w-full p-3 border rounded">
                </div>
                <div>
                    <input type="password" id="password" placeholder="Parola" class="w-full p-3 border rounded">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">
                    Giriş Yap
                </button>
                <p id="login-error" class="text-red-500 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-content" class="hidden p-4 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Profil Düzenleme</h1>
            <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2">
                <i data-lucide="log-out" class="w-4 h-4"></i>
                Çıkış
            </button>
        </div>

        <!-- Message -->
        <div id="message" class="hidden"></div>

        <!-- Basic Info -->
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h2 class="text-xl font-bold mb-4">Temel Bilgiler</h2>
            
            <div class="space-y-4">
                <input type="text" id="name" placeholder="Ad Soyad" class="w-full p-3 border rounded">
                <input type="text" id="title" placeholder="Pozisyon/Ünvan" class="w-full p-3 border rounded">
                <textarea id="bio" placeholder="Hakkında" class="w-full p-3 border rounded" rows="4"></textarea>
                
                <div class="flex gap-4 items-start">
                    <div class="flex-1">
                        <input type="file" onchange="uploadPhoto(event)" class="w-full p-2 border rounded">
                    </div>
                    <img id="photo-preview" class="w-20 h-20 rounded object-cover hidden">
                </div>
            </div>
        </div>

        <!-- Social Media -->
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h2 class="text-xl font-bold mb-4">Sosyal Medya</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="linkedin" placeholder="LinkedIn URL" class="p-3 border rounded">
                <input type="text" id="github" placeholder="GitHub URL" class="p-3 border rounded">
                <input type="text" id="email-contact" placeholder="E-posta" class="p-3 border rounded">
            </div>
        </div>

        <!-- Expertise -->
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Uzmanlık Alanları</h2>
                <button onclick="addExpertise()" class="bg-green-500 text-white px-4 py-2 rounded">+ Ekle</button>
            </div>
            <div id="expertise-container"></div>
        </div>

        <!-- Education -->
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Eğitim</h2>
                <button onclick="addEducation()" class="bg-green-500 text-white px-4 py-2 rounded">+ Ekle</button>
            </div>
            <div id="education-container"></div>
        </div>

        <!-- Experience -->
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">İş Deneyimi</h2>
                <button onclick="addExperience()" class="bg-green-500 text-white px-4 py-2 rounded">+ Ekle</button>
            </div>
            <div id="experience-container"></div>
        </div>

        <!-- Save Button -->
        <button id="save-btn" onclick="saveAll()" class="w-full bg-blue-600 text-white p-4 rounded-lg text-lg font-bold hover:bg-blue-700">
            Tümünü Kaydet
        </button>
    </div>

    <script>
        lucide.createIcons();
    </script>
</body>
</html>
