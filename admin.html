<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Düzenleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind konfigürasyonu, dark mode'u class üzerinden yönetecek şekilde ayarlandı -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // blue-500
                    },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-500">
    
    <!-- Firebase ve Uygulama Mantığı -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase config (DİKKAT: Bu konfigürasyon sadece örnek amaçlıdır.)
        const firebaseConfig = {
            apiKey: "AIzaSyBF0bchfUsw4yo1q1wU-rowR8RZ24CDgJ0",
            authDomain: "mete-73d7c.firebaseapp.com",
            projectId: "mete-73d7c",
            storageBucket: "mete-73d7c.firebasestorage.app",
            messagingSenderId: "785562796791",
            appId: "1:785562796791:web:4ee9767daf4a13a981c9f2",
            measurementId: "G-191XRBGG83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        const PROFILE_DOC_ID = 'main_professional_profile';
        let userId = null;
        let uploadedPhotoURL = null;

        /** TEMA YÖNETİMİ BAŞLANGIÇ */

        // Temayı HTML elementine uygular ve ikonu günceller
        function applyTheme(theme) {
            const htmlEl = document.documentElement;
            const themeIcon = document.getElementById('theme-toggle-icon');

            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                if (themeIcon) themeIcon.setAttribute('data-lucide', 'sun'); // Karanlık modda güneş ikonunu göster
            } else {
                htmlEl.classList.remove('dark');
                if (themeIcon) themeIcon.setAttribute('data-lucide', 'moon'); // Aydınlık modda ay ikonunu göster
            }
            // İkonu yeniden oluştur
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Kaydedilen temayı localStorage'dan yükler
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        // Temayı değiştirir ve localStorage'a kaydeder
        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        
        // Sayfa yüklendiğinde temayı uygula
        window.addEventListener('DOMContentLoaded', loadTheme);

        /** TEMA YÖNETİMİ SONU */

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                loadProfileData();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-content').classList.add('hidden');
            }
        });

        // Login function
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                error.textContent = '';
            } catch (e) {
                error.textContent = 'Giriş başarısız!';
            }
        }

        // Logout function
        async function logout() {
            await signOut(auth);
        }

        // Load profile data
        async function loadProfileData() {
            try {
                // Not: Güvenlik kurallarınıza göre bu yolun herkesin okumasına açık olması gerekir
                const docRef = doc(db, 'artifacts', 'mete-73d7c', 'public', 'data', 'profiles', PROFILE_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Fill form fields
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('title').value = data.title || '';
                    document.getElementById('bio').value = data.bioText || '';
                    document.getElementById('linkedin').value = data.socials?.linkedin || '';
                    document.getElementById('github').value = data.socials?.github || '';
                    document.getElementById('email-contact').value = data.socials?.email || '';

                    // Photo
                    if (data.photoURL) {
                        document.getElementById('photo-preview').src = data.photoURL;
                        document.getElementById('photo-preview').classList.remove('hidden');
                        uploadedPhotoURL = data.photoURL;
                    }

                    // Load lists
                    loadList('expertise', data.expertise || []);
                    loadList('education', data.education || []);
                    loadList('experience', data.workExperience || []);
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Load list items
        function loadList(type, items) {
            const container = document.getElementById(`${type}-container`);
            container.innerHTML = '';
            
            items.forEach(item => {
                addListItem(type, item);
            });
        }

        // Add list item
        function addListItem(type, data = {}) {
            const container = document.getElementById(`${type}-container`);
            let html = '';
            // Tailwind dark mode classes added to inputs/textareas: dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600
            const inputClasses = "w-full p-2 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600";
            const inputClassesMb = inputClasses + " mb-2";

            if (type === 'expertise') {
                html = `
                    <div class="border dark:border-gray-700 p-3 rounded mb-2 bg-gray-50 dark:bg-gray-800">
                        <input type="text" placeholder="Uzmanlık adı" value="${data.name || ''}" class="expertise-name ${inputClassesMb}">
                        <input type="text" placeholder="İkon adı (Lucide ikon adı)" value="${data.icon || ''}" class="expertise-icon ${inputClasses}">
                        <button onclick="removeItem(this)" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
            } else if (type === 'education') {
                html = `
                    <div class="border dark:border-gray-700 p-3 rounded mb-2 bg-gray-50 dark:bg-gray-800">
                        <input type="text" placeholder="Derece" value="${data.degree || ''}" class="${inputClassesMb}">
                        <input type="text" placeholder="Okul" value="${data.institution || ''}" class="${inputClassesMb}">
                        <input type="text" placeholder="Yıllar" value="${data.years || ''}" class="${inputClassesMb}">
                        <textarea placeholder="Açıklama" class="${inputClassesMb} resize-none">${data.description || ''}</textarea>
                        <button onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
            } else if (type === 'experience') {
                html = `
                    <div class="border dark:border-gray-700 p-3 rounded mb-2 bg-gray-50 dark:bg-gray-800">
                        <input type="text" placeholder="Pozisyon" value="${data.title || ''}" class="${inputClassesMb}">
                        <input type="text" placeholder="Şirket" value="${data.company || ''}" class="${inputClassesMb}">
                        <input type="text" placeholder="Yıllar" value="${data.years || ''}" class="${inputClassesMb}">
                        <textarea placeholder="Açıklama" class="${inputClassesMb} resize-none">${data.description || ''}</textarea>
                        <button onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
            }

            container.insertAdjacentHTML('beforeend', html);
        }

        // Remove item
        function removeItem(button) {
            button.parentElement.remove();
        }

        // Photo upload
        async function uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);

            // Upload to Firebase
            try {
                const storageRef = ref(storage, `profile_photos/${userId}/${file.name}`);
                await uploadBytes(storageRef, file);
                uploadedPhotoURL = await getDownloadURL(storageRef);
                showMessage('Fotoğraf yüklendi!', 'green');
            } catch (error) {
                console.error('Fotoğraf yükleme hatası:', error);
                showMessage('Fotoğraf yükleme hatası!', 'red');
            }
        }

        // Save all data
        async function saveAll() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Kaydediliyor...';

            try {
                const docRef = doc(db, 'artifacts', 'mete-73d7c', 'public', 'data', 'profiles', PROFILE_DOC_ID);

                const dataToSave = {
                    name: document.getElementById('name').value,
                    title: document.getElementById('title').value,
                    bioText: document.getElementById('bio').value,
                    photoURL: uploadedPhotoURL || '',
                    socials: {
                        linkedin: document.getElementById('linkedin').value,
                        github: document.getElementById('github').value,
                        email: document.getElementById('email-contact').value
                    },
                    expertise: getExpertiseItems(),
                    education: getEducationItems(),
                    workExperience: getExperienceItems()
                };

                await setDoc(docRef, dataToSave);
                showMessage('Profil kaydedildi!', 'green');

            } catch (error) {
                console.error('Save error:', error);
                showMessage('Kaydetme hatası!', 'red');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Tümünü Kaydet';
            }
        }

        // Get list items
        function getExpertiseItems() {
            const items = [];
            document.querySelectorAll('#expertise-container > div').forEach(div => {
                const name = div.querySelector('.expertise-name').value;
                const icon = div.querySelector('.expertise-icon').value;
                if (name) items.push({ name, icon });
            });
            return items;
        }

        function getEducationItems() {
            const items = [];
            document.querySelectorAll('#education-container > div').forEach(div => {
                const inputs = div.querySelectorAll('input, textarea');
                if (inputs[0].value) {
                    items.push({
                        degree: inputs[0].value,
                        institution: inputs[1].value,
                        years: inputs[2].value,
                        description: inputs[3].value
                    });
                }
            });
            return items;
        }

        function getExperienceItems() {
            const items = [];
            document.querySelectorAll('#experience-container > div').forEach(div => {
                const inputs = div.querySelectorAll('input, textarea');
                if (inputs[0].value) {
                    items.push({
                        title: inputs[0].value,
                        company: inputs[1].value,
                        years: inputs[2].value,
                        description: inputs[3].value
                    });
                }
            });
            return items;
        }

        // Show message
        function showMessage(text, color) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `p-3 rounded mb-4 text-white bg-${color}-500`;
            message.classList.remove('hidden');
            
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        // Global functions
        window.login = login;
        window.logout = logout;
        window.uploadPhoto = uploadPhoto;
        window.saveAll = saveAll;
        window.removeItem = removeItem;
        window.toggleTheme = toggleTheme; // Yeni eklenen tema fonksiyonu
        window.addExpertise = () => addListItem('expertise');
        window.addEducation = () => addListItem('education');
        window.addExperience = () => addListItem('experience');
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-blue-600 dark:bg-blue-800 transition-colors duration-500">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-96">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-900 dark:text-gray-100">Yönetici Girişi</h2>
            
            <div class="space-y-4">
                <div>
                    <input type="email" id="email" placeholder="E-posta" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                </div>
                <div>
                    <input type="password" id="password" placeholder="Parola" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition duration-300">
                    Giriş Yap
                </button>
                <p id="login-error" class="text-red-500 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-content" class="hidden p-4 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100">Profil Düzenleme</h1>
            <div class="flex gap-3">
                <!-- TEMA DEĞİŞTİRME BUTONU -->
                <button onclick="toggleTheme()" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-full flex items-center gap-2 transition duration-300 hover:bg-gray-300 dark:hover:bg-gray-600 shadow-md">
                    <i id="theme-toggle-icon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <!-- ÇIKIŞ BUTONU -->
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-full flex items-center gap-2 hover:bg-red-600 transition shadow-md">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    Çıkış
                </button>
            </div>
        </div>

        <!-- Message -->
        <div id="message" class="hidden text-center font-medium"></div>

        <!-- Basic Info -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 transition-colors duration-500">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100 border-b pb-2 dark:border-gray-700">Temel Bilgiler</h2>
            
            <div class="space-y-4">
                <input type="text" id="name" placeholder="Ad Soyad" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <input type="text" id="title" placeholder="Pozisyon/Ünvan" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <textarea id="bio" placeholder="Hakkında" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600" rows="4"></textarea>
                
                <div class="flex gap-4 items-start">
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Profil Fotoğrafı Yükle</label>
                        <input type="file" onchange="uploadPhoto(event)" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <img id="photo-preview" class="w-24 h-24 rounded-full object-cover hidden border-4 border-gray-200 dark:border-gray-600 shadow-md" alt="Profil Fotoğrafı Önizleme">
                </div>
            </div>
        </div>

        <!-- Social Media -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 transition-colors duration-500">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100 border-b pb-2 dark:border-gray-700">Sosyal Medya</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="linkedin" placeholder="LinkedIn URL" class="p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <input type="text" id="github" placeholder="GitHub URL" class="p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <input type="text" id="email-contact" placeholder="E-posta" class="p-3 border rounded dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
            </div>
        </div>

        <!-- Expertise -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 transition-colors duration-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Uzmanlık Alanları</h2>
                <button onclick="addExpertise()" class="bg-green-500 text-white px-4 py-2 rounded-full flex items-center gap-1 hover:bg-green-600 transition shadow-md">
                    <i data-lucide="plus" class="w-4 h-4"></i> Ekle
                </button>
            </div>
            <div id="expertise-container"></div>
        </div>

        <!-- Education -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 transition-colors duration-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Eğitim</h2>
                <button onclick="addEducation()" class="bg-green-500 text-white px-4 py-2 rounded-full flex items-center gap-1 hover:bg-green-600 transition shadow-md">
                    <i data-lucide="plus" class="w-4 h-4"></i> Ekle
                </button>
            </div>
            <div id="education-container"></div>
        </div>

        <!-- Experience -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 transition-colors duration-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">İş Deneyimi</h2>
                <button onclick="addExperience()" class="bg-green-500 text-white px-4 py-2 rounded-full flex items-center gap-1 hover:bg-green-600 transition shadow-md">
                    <i data-lucide="plus" class="w-4 h-4"></i> Ekle
                </button>
            </div>
            <div id="experience-container"></div>
        </div>

        <!-- Save Button -->
        <button id="save-btn" onclick="saveAll()" class="w-full bg-blue-600 text-white p-4 rounded-xl text-lg font-bold hover:bg-blue-700 transition duration-300 shadow-xl mb-12">
            Tümünü Kaydet
        </button>
    </div>

    <script>
        // Sayfa tamamen yüklendiğinde Lucide ikonlarını oluştur
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
